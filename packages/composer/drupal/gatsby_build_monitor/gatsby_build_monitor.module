<?php

use Drupal\Core\Url;
use Drupal\silverback_gatsby\Gatsby;

/**
 * Implements hook_toolbar().
 */
function gatsby_build_monitor_toolbar() {
  $siteUrl = \Drupal::config('gatsby_build_monitor.settings')->get('site_url');
  $url = $siteUrl
    ? Url::fromUri($siteUrl)
    : Url::fromRouteMatch(\Drupal::routeMatch())->setOption('fragment', '#');

  switch (_gatsby_build_monitor_state()) {
    case 'idle':
      $state = t('Gatsby is ready');
      break;
    case 'building':
      $state = t('Gatsby is building');
      break;
    default:
      $state = t('Gatsby status is unknown');
  }

  return [
    'gatsby_build_monitor_state' => [
      '#type' => 'toolbar_item',
      'tab' => [
        '#type' => 'link',
        '#title' => $state,
        '#url' => $url,
        '#attributes' => [
          'class' => ['gatsby-build-monitor-state'],
        ],
        '#cache' => [
          'max-age' => 0,
        ],
      ],
      '#attached' => [
        'library' => ['gatsby_build_monitor/state'],
      ],
      '#weight' => 1000,
    ],
  ];
}

/**
 * Sets or returns Gatsby rebuild state.
 *
 * @param string|null $state
 *   Values: "idle" or "building".
 *
 * @return void|string
 *   Values: "idle", "building" or "unknown".
 */
function _gatsby_build_monitor_state($state = NULL) {
  if ($state === NULL) {
    return \Drupal::state()->get('gatsby_build_monitor.state') ?? 'unknown';
  }
  \Drupal::state()->set('gatsby_build_monitor.state', $state);
}
